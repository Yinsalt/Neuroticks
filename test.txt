#!/bin/bash
#===============================================================================
# NeuroTicks Installation Script
# Kompiliert NEST 3.8 aus Source mit allen Abhängigkeiten
# Für Ubuntu 22.04/24.04
#===============================================================================

set -e

# Farben
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_header() {
    echo ""
    echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
    echo ""
}

print_step() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_info() {
    echo -e "${CYAN}[i]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

#===============================================================================
# Konfiguration
#===============================================================================

NEST_VERSION="3.8"
NEST_BRANCH="v${NEST_VERSION}"
PYTHON_VERSION="3.12"

# NeuroTicks Repository
NEUROTICKS_REPO="https://github.com/Yinsalt/NeuroTicks.git"

# Installationspfade
INSTALL_DIR="${HOME}/neuroticks"
VENV_DIR="${INSTALL_DIR}/venv"
NEST_SRC_DIR="${INSTALL_DIR}/nest-src"
NEST_BUILD_DIR="${INSTALL_DIR}/nest-build"
NEUROTICKS_DIR="${INSTALL_DIR}/NeuroTicks"

# Build-Optionen
NUM_CORES=$(nproc)
USE_MPI=${USE_MPI:-OFF}
USE_OPENMP=${USE_OPENMP:-ON}

#===============================================================================
# Prüfungen
#===============================================================================

print_header "NeuroTicks Installer - NEST ${NEST_VERSION} from Source"

# Nicht als root
if [ "$EUID" -eq 0 ]; then
    print_error "Bitte NICHT als root ausführen!"
    exit 1
fi

# OS prüfen
if [ -f /etc/os-release ]; then
    . /etc/os-release
    print_info "System: $NAME $VERSION_ID"
else
    print_error "Nur für Debian/Ubuntu"
    exit 1
fi

# Python Version prüfen
if ! command -v python${PYTHON_VERSION} &> /dev/null; then
    print_warning "Python ${PYTHON_VERSION} nicht gefunden."
    print_info "Versuche Installation..."
    sudo apt-get update
    sudo apt-get install -y python${PYTHON_VERSION} python${PYTHON_VERSION}-venv python${PYTHON_VERSION}-dev
fi

PYTHON_EXEC=$(which python${PYTHON_VERSION})
print_step "Python: ${PYTHON_EXEC}"

#===============================================================================
# Verzeichnisstruktur
#===============================================================================

print_header "Verzeichnisse vorbereiten"

mkdir -p "${INSTALL_DIR}"
mkdir -p "${NEST_BUILD_DIR}"

print_step "Installationsverzeichnis: ${INSTALL_DIR}"

#===============================================================================
# System-Abhängigkeiten
#===============================================================================

print_header "System-Abhängigkeiten installieren"

print_info "Paketlisten aktualisieren..."
sudo apt-get update

print_info "Build-Tools installieren..."
sudo apt-get install -y \
    build-essential \
    cmake \
    git \
    wget \
    curl \
    autoconf \
    automake \
    libtool \
    pkg-config

print_info "NEST Build-Abhängigkeiten..."
sudo apt-get install -y \
    libgsl-dev \
    libltdl-dev \
    libncurses-dev \
    libreadline-dev \
    libboost-dev \
    libboost-filesystem-dev \
    libboost-system-dev \
    cython3

print_info "Python Development Headers..."
sudo apt-get install -y \
    python${PYTHON_VERSION}-dev \
    python${PYTHON_VERSION}-venv

print_info "Qt6 und GUI-Abhängigkeiten..."
sudo apt-get install -y \
    qt6-base-dev \
    libqt6opengl6-dev \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    libegl1 \
    libxrender1 \
    libxcb-xinerama0 \
    libxcb-cursor0 \
    libxkbcommon-x11-0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-randr0 \
    libxcb-render-util0 \
    libxcb-shape0 \
    libdbus-1-3 \
    libfontconfig1 \
    libgtk-3-0 \
    libxcb-cursor0

# Optional: MPI
if [ "${USE_MPI}" = "ON" ]; then
    print_info "MPI installieren..."
    sudo apt-get install -y openmpi-bin libopenmpi-dev
fi

print_step "System-Abhängigkeiten installiert!"

#===============================================================================
# Virtuelle Umgebung
#===============================================================================

print_header "Python Virtual Environment erstellen"

if [ -d "${VENV_DIR}" ]; then
    print_warning "Venv existiert bereits: ${VENV_DIR}"
    read -p "Löschen und neu erstellen? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "${VENV_DIR}"
    else
        print_info "Benutze existierende venv."
    fi
fi

if [ ! -d "${VENV_DIR}" ]; then
    python${PYTHON_VERSION} -m venv "${VENV_DIR}"
    print_step "Venv erstellt: ${VENV_DIR}"
fi

# Aktivieren
source "${VENV_DIR}/bin/activate"
print_step "Venv aktiviert"

# pip upgraden
print_info "pip aktualisieren..."
pip install --upgrade pip wheel setuptools

#===============================================================================
# Python-Pakete (VOR NEST - wegen Cython/NumPy)
#===============================================================================

print_header "Python-Pakete installieren"

print_info "NumPy und Cython (für NEST Build benötigt)..."
pip install numpy cython

print_info "Scientific Stack..."
pip install \
    pandas \
    scipy \
    networkx \
    matplotlib

print_info "PyQt6 GUI..."
pip install \
    PyQt6 \
    PyQt6-WebEngine \
    pyqtgraph

print_info "3D Visualization..."
pip install \
    vtk \
    pyvista \
    pyvistaqt

print_info "Development Tools..."
pip install ipython

print_step "Python-Pakete installiert!"

#===============================================================================
# NEST aus Source kompilieren
#===============================================================================

print_header "NEST ${NEST_VERSION} aus Source kompilieren"

# Source clonen oder updaten
if [ -d "${NEST_SRC_DIR}" ]; then
    print_info "NEST Source existiert, update..."
    cd "${NEST_SRC_DIR}"
    git fetch --all --tags
    git checkout "${NEST_BRANCH}"
    git pull origin "${NEST_BRANCH}" || true
else
    print_info "NEST Source clonen..."
    git clone --branch "${NEST_BRANCH}" --depth 1 \
        https://github.com/nest/nest-simulator.git "${NEST_SRC_DIR}"
fi

print_step "Source bereit: ${NEST_SRC_DIR}"

# Build-Verzeichnis säubern
print_info "Build-Verzeichnis vorbereiten..."
rm -rf "${NEST_BUILD_DIR}"/*
cd "${NEST_BUILD_DIR}"

# CMake konfigurieren
print_info "CMake konfigurieren..."

# Python-Pfade ermitteln
PYTHON_EXEC="${VENV_DIR}/bin/python"
PYTHON_INCLUDE=$(${PYTHON_EXEC} -c "import sysconfig; print(sysconfig.get_path('include'))")
PYTHON_LIBRARY=$(${PYTHON_EXEC} -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")/libpython${PYTHON_VERSION}.so

print_info "  Python: ${PYTHON_EXEC}"
print_info "  Include: ${PYTHON_INCLUDE}"

cmake "${NEST_SRC_DIR}" \
    -DCMAKE_INSTALL_PREFIX="${VENV_DIR}" \
    -DPYTHON_EXECUTABLE="${PYTHON_EXEC}" \
    -DPYTHON_INCLUDE_DIR="${PYTHON_INCLUDE}" \
    -Dwith-python=ON \
    -Dwith-gsl=ON \
    -Dwith-readline=ON \
    -Dwith-ltdl=ON \
    -Dwith-openmp=${USE_OPENMP} \
    -Dwith-mpi=${USE_MPI} \
    -Dwith-boost=ON \
    -Dwith-optimize="-O2" \
    -DCMAKE_BUILD_TYPE=Release

print_step "CMake konfiguriert!"

# Kompilieren
print_info "Kompilieren mit ${NUM_CORES} Kernen..."
print_info "Das kann 10-30 Minuten dauern..."
make -j${NUM_CORES}

print_step "Kompilierung abgeschlossen!"

# Installieren
print_info "NEST installieren..."
make install

print_step "NEST ${NEST_VERSION} installiert!"

#===============================================================================
# Umgebungsvariablen Setup
#===============================================================================

print_header "Umgebung konfigurieren"

# Aktivierungs-Script erstellen
ACTIVATE_SCRIPT="${INSTALL_DIR}/activate_neuroticks.sh"

cat > "${ACTIVATE_SCRIPT}" << 'ACTIVATE_EOF'
#!/bin/bash
# NeuroTicks Environment Activation Script
# Source this file: source activate_neuroticks.sh

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="${SCRIPT_DIR}/venv"

if [ -f "${VENV_DIR}/bin/activate" ]; then
    source "${VENV_DIR}/bin/activate"
    
    # NEST Umgebungsvariablen
    if [ -f "${VENV_DIR}/bin/nest_vars.sh" ]; then
        source "${VENV_DIR}/bin/nest_vars.sh"
    fi
    
    echo "NeuroTicks environment activated!"
    echo "  Python: $(which python)"
    echo "  NEST:   $(python -c 'import nest; print(nest.__version__)' 2>/dev/null || echo 'checking...')"
else
    echo "Error: Virtual environment not found at ${VENV_DIR}"
    return 1
fi
ACTIVATE_EOF

chmod +x "${ACTIVATE_SCRIPT}"
print_step "Aktivierungs-Script: ${ACTIVATE_SCRIPT}"

# nest_vars.sh sourcen falls vorhanden
if [ -f "${VENV_DIR}/bin/nest_vars.sh" ]; then
    source "${VENV_DIR}/bin/nest_vars.sh"
fi

#===============================================================================
# Verifikation
#===============================================================================

print_header "Installation verifizieren"

python << 'VERIFY_EOF'
import sys

print(f"Python: {sys.version}")
print("-" * 50)

packages = [
    ("numpy", "numpy"),
    ("pandas", "pandas"),
    ("scipy", "scipy"),
    ("networkx", "networkx"),
    ("matplotlib", "matplotlib"),
    ("PyQt6", "PyQt6.QtCore"),
    ("pyqtgraph", "pyqtgraph"),
    ("pyvista", "pyvista"),
    ("pyvistaqt", "pyvistaqt"),
    ("vtk", "vtk"),
    ("nest", "nest"),
]

all_ok = True
for name, import_name in packages:
    try:
        module = __import__(import_name.split('.')[0])
        if '.' in import_name:
            for part in import_name.split('.')[1:]:
                module = getattr(module, part)
        version = getattr(module, '__version__', '✓')
        print(f"  ✓ {name:<15} {version}")
    except Exception as e:
        print(f"  ✗ {name:<15} FEHLT ({e})")
        all_ok = False

print("-" * 50)

if all_ok:
    # NEST Funktionstest
    try:
        import nest
        nest.ResetKernel()
        nest.Create('iaf_psc_alpha')
        print("\n✓ NEST Funktionstest erfolgreich!")
    except Exception as e:
        print(f"\n✗ NEST Funktionstest fehlgeschlagen: {e}")
        all_ok = False

sys.exit(0 if all_ok else 1)
VERIFY_EOF

#===============================================================================
# NeuroTicks herunterladen
#===============================================================================

print_header "NeuroTicks herunterladen"

if [ -d "${NEUROTICKS_DIR}" ]; then
    print_info "NeuroTicks existiert bereits, update..."
    cd "${NEUROTICKS_DIR}"
    git pull origin main || git pull origin master || true
else
    print_info "NeuroTicks clonen..."
    git clone "${NEUROTICKS_REPO}" "${NEUROTICKS_DIR}"
fi

print_step "NeuroTicks bereit: ${NEUROTICKS_DIR}"

#===============================================================================
# Abschluss
#===============================================================================

print_header "Installation abgeschlossen!"

echo -e "${GREEN}NEST ${NEST_VERSION} wurde erfolgreich aus Source kompiliert!${NC}"
echo ""
echo "Installation: ${INSTALL_DIR}"
echo ""
echo -e "${CYAN}Verwendung:${NC}"
echo ""
echo "  1. Umgebung aktivieren:"
echo "     source ${ACTIVATE_SCRIPT}"
echo ""
echo "  2. NeuroTicks starten:"
echo "     cd ${NEUROTICKS_DIR}"
echo "     python Main.py"
echo ""
echo "  3. Oder zur .bashrc hinzufügen:"
echo "     echo 'alias neuroticks=\"source ${ACTIVATE_SCRIPT} && cd ${NEUROTICKS_DIR}\"' >> ~/.bashrc"
echo ""
echo "  4. Danach einfach mit:"
echo "     neuroticks"
echo "     python Main.py"
echo ""
print_step "Fertig!"
